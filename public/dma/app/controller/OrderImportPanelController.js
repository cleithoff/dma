/*
 * File: app/controller/OrderImportPanelController.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.OrderImportPanelController', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            autoCreate: true,
            ref: 'OrderImportPanel',
            selector: '#OrderImportPanel',
            xtype: 'orderimportpanel'
        }
    ],

    onOrderImportResetButtonClick: function(button, e, eOpts) {
        fp = this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel');

        fp.getForm().reset();
    },

    onOrderImportUploadButtonClick: function(button, e, eOpts) {
        var fp = this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel');

        var that = this;

        //if(fp.getForm().isValid()){
        fp.getForm().submit({
            url: '/import/fileupload/order',
            waitMsg: 'Datei wird hochgeladen...',
            success: function(x, o){
                Ext.Msg.show({
                    title: 'Datei-Upload',
                    msg: o.result.msg,
                    minWidth: 200,
                    modal: true,
                    icon: Ext.Msg.INFO,
                    buttons: Ext.Msg.OK
                });
                if (o.result.success === true) {
                    var myMask = new Ext.LoadMask(Ext.getBody(), {msg:"Bitte warten Sie. Dieser Vorgang kann mehrere Minuten dauern!"});
                    myMask.show();
                    Ext.Ajax.request({
                        url: '/import/import/order',
                        timeout: 60 * 30 * 1000, // 30 min
                        params: {
                            filename: o.result.filename,
                            product_item_id: fp.getComponent('OrderImportItemComboBox').getValue(),
                        },
                        success: function(response, opts) {
                            var obj = Ext.decode(response.responseText);
                            //console.dir(obj);
                            if (obj.success == 0) {
                                Ext.Msg.show({
                                    title: 'Fehler',
                                    msg: obj.message,
                                    minWidth: 200,
                                    modal: true,
                                    icon: Ext.Msg.INFO,
                                    buttons: Ext.Msg.OK
                                });
                            } else {	
                                store = that.getOrderImportPanel().down('#OrderImportGridPanel').getStore(); //Ext.getStore('ImportOrderTreeStore');					
                                store.getProxy().setExtraParam('product_item_id', that.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportItemComboBox').getValue());
                                store.getRootNode().removeAll();
                                store.load();
                            }
                            myMask.destroy();

                        },
                        failure: function(response, opts) {
                            myMask.destroy();
                            //console.log('server-side failure with status code ' + response.status);
                        }
                    });
                } else {
                    alert('Upload fehlgeschlagen. Bitte die Datei schließen, falls diese noch geöffnet ist.');
                }
            },
            failure: function(x,o) {
                alert('Upload fehlgeschlagen. Bitte die Datei schließen, falls diese noch geöffnet ist.');
            }
        });
        //}
    },

    onOrderImportImportButtonClick: function(button, e, eOpts) {
        var that = this;

        var myMask = new Ext.LoadMask(Ext.getBody(), {msg:"Bitte warten Sie. Dieser Vorgang kann mehrere Minuten dauern!"});
        myMask.show();

        Ext.Ajax.request({
            url: '/import/order/import',
            method: 'GET',
            timeout: 60 * 10 * 1000, // 10 min
            params: {
                import_import_id: this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('ImportImportComboBox').getValue(),
                product_product_id: this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportProductComboBox').getValue(),
                product_item_id: this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportItemComboBox').getValue(),
                haspos: this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportHasposCheckbox').getValue(),
                weightpos: this.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportWeightposNumberfield').getValue(),
            },
            success: function(response, opts) {
                //var obj = Ext.decode(response.responseText);
                //console.dir(obj);
                //Ext.getStore('ImportOrderTreeStore').removeAll();
                //Ext.getStore('ImportOrderTreeStore').sync();
                store = that.getOrderImportPanel().down('#OrderImportGridPanel').getStore(); //store = Ext.getStore('ImportOrderTreeStore');
                store.getProxy().setExtraParam('product_item_id', that.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportItemComboBox').getValue());
                store.reload();
                myMask.destroy();
            },
            failure: function(response, opts) {
                myMask.destroy();
                //console.log('server-side failure with status code ' + response.status);
            }
        });
    },

    onOrderImportRefreshButtonClick: function(button, e, eOpts) {
        var me = this;
        //store = Ext.getStore('ImportOrderTreeStore');
        store = me.getOrderImportPanel().down('#OrderImportGridPanel').getStore();
        store.getProxy().setExtraParam('product_item_id', me.getOrderImportPanel().getComponent('OrderImportUploadFormPanel').getComponent('OrderImportItemComboBox').getValue());
        store.getRootNode().removeAll();
        store.load();
    },

    init: function(application) {
        this.control({
            "#OrderImportResetButton": {
                click: this.onOrderImportResetButtonClick
            },
            "#OrderImportUploadButton": {
                click: this.onOrderImportUploadButtonClick
            },
            "#OrderImportImportButton": {
                click: this.onOrderImportImportButtonClick
            },
            "#OrderImportRefreshButton": {
                click: this.onOrderImportRefreshButtonClick
            }
        });
    }

});
