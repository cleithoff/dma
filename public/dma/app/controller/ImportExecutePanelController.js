/*
 * File: app/controller/ImportExecutePanelController.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.ImportExecutePanelController', {
    extend: 'Ext.app.Controller',

    refs: [
        {
            autoCreate: true,
            ref: 'ImportExecutePanel',
            selector: '#ImportExecutePanel',
            xtype: 'importexecutepanel'
        },
        {
            autoCreate: true,
            ref: 'ImportPanel',
            selector: '#ImportPanel',
            xtype: 'importpanel'
        }
    ],

    onImportExecuteUploadButtonClick: function(button, e, eOpts) {
        var fp = this.getImportExecutePanel().getComponent('ImportExecuteFormPanel');
        var p = this.getImportPanel();

        record = p.getComponent('ImportImportGridPanel').getSelectionModel().getSelection()[0];

        if (record === undefined) {
            alert('Bitte einen Import wählen.');
            return;
        }

        var import_import_id = record.data.id;

        var that = this;

        //if(fp.getForm().isValid()){
        fp.getForm().submit({
            url: '/import/fileupload/execute',
            waitMsg: 'Datei wird hochgeladen...',
            success: function(x, o){
                Ext.Msg.show({
                    title: 'Datei-Upload',
                    msg: o.result.msg,
                    minWidth: 200,
                    modal: true,
                    icon: Ext.Msg.INFO,
                    buttons: Ext.Msg.OK
                });
                if (o.result.success === true) {
                    Ext.Ajax.request({
                        url: '/import/import/execute',
                        timeout: 60 * 10 * 1000, // 10 min
                        params: {
                            filename: o.result.filename,
                            import_import_id: import_import_id,
                        },
                        success: function(response, opts) {
                            //var obj = Ext.decode(response.responseText);
                            //console.dir(obj);
                            alert('Daten verarbeitet.');
                        },
                        failure: function(response, opts) {
                            //console.log('server-side failure with status code ' + response.status);
                        }
                    });
                } else {
                    alert('Upload fehlgeschlagen. Bitte die Datei schließen, falls diese noch geöffnet ist.');
                }
            },
            failure: function(x,o) {
                alert('Upload fehlgeschlagen. Bitte die Datei schließen, falls diese noch geöffnet ist.');
            }
        });
        //}
    },

    init: function(application) {
        this.control({
            "#ImportExecuteUploadButton": {
                click: this.onImportExecuteUploadButtonClick
            }
        });
    }

});
